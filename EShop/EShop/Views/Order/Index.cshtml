@model EShop.Models.OrderHistoryModel

@{
    ViewData["Title"] = "Order";
}

<div id="review-modal-id" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Leave a comment!</h4>
                <button id="comment-exit-btn" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form asp-controller="Order" asp-action="LeaveReview" method="post">
                    <div class="form-group Rating">
                        <select id="rating-id">
                            @for (Int16 i = 1; i < 6; i++)
                            {
                            <option value="@i">@i</option>
                            }
                        </select>
                    </div>
                    <div class="form-group ExtraComments">
                        <input id="comment-id" type="text" required="required" />
                    </div>
                    <button type="submit" class="btn btn-success" id="confirm-review-btn">Leave Comment</button>
                </form>
            </div>
            <div class="modal-footer">
                <button id="modal-continue-btn" type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<div id="repurchase-modal-id" class="modal" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button id="exit-repurchase-btn" type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Confirm Addition</h4>
            </div>
            <div class="modal-body">
                <p>Your shopping cart will be used to repurchase items from this order</p>
            </div>
            <div class="modal-footer">
                <form asp-controller="Order" asp-action="Repurchase" method="post" class="form-inline" role="form">  
                    <button id="confirm-repurchase-btn" type="submit" class="btn btn-success"><span class="glyphicon glyphicon-thumbs-up" style="vertical-align:middle;margin-top: -5px"></span> Confirm</button>
                    <button id="close-repurchase-btn" type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="main" style="margin-left:auto">
    <h2>Order History</h2>
    <table class="table">
        <thead>
            <tr>
                <th>
                    <p>Status</p>
                </th>
                <th>
                    <p>Total Price</p>
                </th>
                <th>
                    <p>Delivery Address</p>
                </th>
                <th>
                    <p>Card Number</p>
                </th>
                <th>
                    <p>Purchase Time</p>
                </th>
                <th>
                    <p>Confirmed Time</p>
                </th>
                <th>
                    <p>Repurchase</p>
                </th>
                <th>
                    <p>Review</p>
                </th>
            </tr>
        </thead>
        <tbody>

            @foreach (var item in Model.Orders.Select((value, index) => new { Value = value, Index = index }))
            {
                <tr>
                    <td>
                        @if (item.Value.StatusCode == 1)
                        {
                            <p>Pending</p>
                        }
                        else if (item.Value.StatusCode == 2)
                        {
                            <p>Confirmed</p>
                        }
                        else if (item.Value.StatusCode == 3)
                        {
                            <p>Rejected</p>
                        }
                        else if (item.Value.StatusCode == 4)
                        {
                            <p>Complete</p>
                        }
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Value.TotalPrice)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Value.Address)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Value.CardNumber)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Value.PurchaseDate)
                    </td>
                    <td>
                        @if (item.Value.StatusCode == 1)
                        {
                            <p>Confirmation Pending</p>
                        }
                        else
                        {
                            @Html.DisplayFor(modelItem => item.Value.ConfirmationDate)
                        }
                    </td>
                    <td>
                        <button type="button" id="repurchase-btn" class="btn btn-info" onclick="repurchaseOpen(@item.Value.Id)">Add to cart</button>
                    </td>
                    <td>
                        @if (item.Value.StatusCode == 2)
                        {
                            <button type="button" id="review-btn" class="btn btn-info" onclick="reviewOpen(@item.Value.Id)">Review</button>
                        }
                        else if (item.Value.StatusCode == 4)
                        {
                            <p>@Model.Reviews.Find(orm => orm.OrderId == item.Value.Id).CustomerComment</p>
                        }
                        else
                        {
                            <p>Awaiting Confirmation</p>
                        }
                    </td>
                </tr>
            }

        </tbody>
    </table>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">

    var selectedId = 0;

    function repurchaseOpen(Id) {
        selectedId = Id;
        $('#repurchase-modal-id').fadeIn();
    }

    function reviewOpen(Id) {
        selectedId = Id;
        $('#review-modal-id').fadeIn();
    }

    $(document).ready(function () {

        $('#confirm-repurchase-btn').click(function (e) {

            e.preventDefault();

            var Selector = {
                SelectedValue: selectedId
            }

            $.ajax({
                type: 'POST',
                url: '@Url.Action("Repurchase", "Order")',
                data: JSON.stringify(Selector),
                dataType: 'json',
                contentType: "application/json",
                success: function (response) {
                    if (response == 0) {
                        $('#repurchase-modal-id').fadeOut();
                    }
                    else if (response == 1) {
                        //TODO: handle failure sent from controller (modify modal box)
                    }
                },
                failure: function (response) {
                    //TODO: handle AJAX request failure
                }
            });
        });

        $('#confirm-review-btn').click(function (e) {

            e.preventDefault();

            var Rating = $('#rating-id').val();
            var Comment = $('#comment-id').val();

            var ReviewPostModel = {
                OrderId: selectedId,
                Rating: Rating,
                Comment: Comment
            }

            $.ajax({
                type: 'POST',
                url: '@Url.Action("LeaveReview", "Order")',
                data: JSON.stringify(ReviewPostModel),
                dataType: 'json',
                contentType: "application/json",
                success: function (response) {
                    if (response == 0) {
                        $('#review-modal-id').fadeOut();
                        location.reload();
                    }
                    else if (response == 1) {
                        //TODO: handle failure sent from controller (modify modal box)
                    }
                },
                failure: function (response) {
                    //TODO: handle AJAX request failure
                }
            });
        });

        $('#modal-continue-btn, #comment-exit-btn').click(function () {
            $('#review-modal-id').fadeOut();
        });

        $('#exit-repurchase-btn, #close-repurchase-btn').click(function () {
            $('#repurchase-modal-id').fadeOut();
        });
    });
</script>