@model IEnumerable<EShop.Models.ProductDetails>

@{
    ViewData["Title"] = "ProductPage";
}

<head>
    <link rel="stylesheet" type="text/css" href="~/css/image_modal.css" media="screen" /> <!--Css file for image modal-->
</head>

<!-- Pop-up modal on "Add" button click -->
<div id="add-modal-id" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <img src="~/images/success.png" width="30" height="30" /> &nbsp; Success!

                <button id="modal-exit-btn" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>A new item has been added to your Shopping Cart.</p>
            </div>
            <div class="modal-footer">
                <form asp-controller="ShoppingCart" asp-action="Index">
                    <button type="submit" class="btn btn-primary">
                        <span class="glyphicon glyphicon-shopping-cart" aria-hidden="true"></span> View Shopping Cart
                    </button>
                </form>
                <br />
                <button id="modal-continue-btn" type="button" class="btn btn-secondary" data-dismiss="modal">Continue Shopping</button>
            </div>
        </div>
    </div>
</div>

<!--Overall page view-->
<div class="sidenav">
    <h3>Perfect<br /> place for your advertisements!</h3>
</div>

<div class="main">
    <h2>@ViewBag.Product.Name</h2>
    <img id="productImage" src="~/images/products/@ViewBag.PrimaryImage" height="180" width="150" alt="Primary Image" style="float: left; margin-right: 10px; margin-top: 20px;">

    <!--Enlarged image modal-->
    <div id="imageModal" class="modal-image">
        <!-- The Close Button -->
        <span id="imgClose" class="close">&times;</span>
        <!-- Modal Content (The Image) -->
        <img class="modal-content" id="img01">
        <!-- Modal Caption (Image Text) -->
        <div id="caption"></div>
    </div>

    <div id="sidebar">
        <h3 style="margin-top: 70px; margin-left: 200px;">Current price is: €@ViewBag.Product.Price</h3>
        @if (!this.User.IsInRole("Admin"))
        {
            <div>
                <form id="add-btn-form" style="margin-left: 200px;">
                    Quantity &nbsp<input id="quantity-id" type="number" size="2" min="1" value="1" required="required" />
                    <input id="hidden-id" type="hidden" size="2" value="@ViewBag.Product.Id" required="required" />
                    <button id="add-btn" type="submit" class="btn btn-info">
                        <span class="glyphicon glyphicon-shopping-cart" aria-hidden="true"></span> Add
                    </button>
                </form>
            </div>
        }
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>
                    @Html.DisplayNameFor(model => model.Property)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Description)
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Where(m => m.ProductId == ViewBag.Product.Id)) //Convert.ToInt32(ViewData["product_id"])))
            {
                <tr>
                    <td>
                        @Html.DisplayFor(modelItem => item.Property)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Description)
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <div class="alert alert-success" role="alert">
    </div>
</div>

<!-- Scripts -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
    $(document).ready(function () {

        $('#modal-exit-btn, #modal-continue-btn').click(function () {
            $('#add-modal-id').fadeOut();
        });


        //Below is the code that responds for image preview
        var modal = document.getElementById('imageModal');

        // Get the image and insert it inside the modal - use its "alt" text as a caption
        var img = document.getElementById('productImage');
        var modalImg = document.getElementById("img01");
        var captionText = document.getElementById("caption");

        img.onclick = function () {
            modal.style.display = "block";
            modalImg.src = this.src;
            captionText.innerHTML = '@ViewBag.Product.Name'; //this.alt; <-- name of picture
        }

        // Get the <span> element that closes the modal
        //var span = document.getElementsByClassName("close")[0];
        var span = document.getElementById('imgClose');

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
            modal.style.display = "none";
        }



        //Below is code that responds for "add to cart" button operation
        @{
            <text>
                $('#add-btn').click(function (e) {

                    e.preventDefault();// prevents page refreshing

                    // Arguments we pass to controller's action method
                    var ProductToCartPostModel = { // must match ~/Models/PostModels/ProductToCartPostModel.cs
                        ProductId: $('#hidden-id').val(),
                        Quantity: $('#quantity-id').val()
                    }

                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("AddProductToShoppingCart", "ShoppingCart")',
                        data: JSON.stringify(ProductToCartPostModel),
                        dataType: 'json',
                        contentType: "application/json",
                        success: function (response) {
                            if (response == 0) {
                                $('#add-modal-id').fadeIn();
                            }
                            else if (response == 1) {
                                //TODO: handle failure sent from controller (modify modal box)
                            }
                        },
                        failure: function (response) {
                            //TODO: handle AJAX request failure
                        }
                    });
                });
            </text>
        }
    });
</script>

